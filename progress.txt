# Ralph Progress Log

Started: 2026-02-20
Project: terraform-town - Mock AWS Provider

## Codebase Patterns

- Schema location: `packages/aws-mock/schema/aws-provider-schema.json` (AWS provider v5.100.0, 13MB)
- Schema access: `data.provider_schemas["registry.terraform.io/hashicorp/aws"].resource_schemas["aws_s3_bucket"]`
- Test files: `packages/aws-mock/tests/*.test.ts` using `bun:test`
- Formatting: `npx oxfmt format <file>` (oxfmt not globally installed)
- Schema parser: `parseResourceDefinition(type)` in `packages/aws-mock/src/utils/schema-parser.ts`
- Schema attribute categories: required (required=true), optional (optional=true, may also be computed), computed-only (computed=true && !optional)
- aws_s3_bucket has 0 required attrs, ~10 optional, 7 computed-only, 10 nested blocks
- Resource types: `packages/aws-mock/src/resources/types.ts` — ResourceHandler, ResourceContext, ResourceResult
- ResourceHandler CRUD: create→ResourceResult, read→ResourceResult|null, update→ResourceResult, delete→void
- State store: `StateStore` class in `packages/aws-mock/src/state/store.ts` — JSON file-backed, keyed by type/id
- State format: `{ version: 1, resources: { [type]: { [id]: { id, attributes } } } }`
- Computed values: `packages/aws-mock/src/utils/computed.ts` — generateS3Arn, generateS3Id, generateS3Domain, generateAccountId
- Account ID: fixed mock value "123456789012" (consistent across calls)
- S3 domain: `bucket.s3.amazonaws.com` for us-east-1, `bucket.s3.region.amazonaws.com` for others
- Resource handlers: factory function pattern `createXxxHandler(store: StateStore): ResourceHandler` in `packages/aws-mock/src/resources/`
- S3 bucket handler: `createS3BucketHandler` in `packages/aws-mock/src/resources/s3-bucket.ts`
- bucket_domain_name always uses us-east-1 format, bucket_regional_domain_name always includes region
- S3 hosted zone ID for us-east-1: "Z3AQBSTGFYJSTF"
- S3 bucket policy handler: `createS3BucketPolicyHandler` in `packages/aws-mock/src/resources/s3-bucket-policy.ts`
- S3 bucket policy ID is the bucket name (same as AWS behavior)
- S3 bucket policy schema: bucket (required), policy (required), id (computed) — no nested blocks

## 2026-02-20 14:59 - US-002
- Installed terraform via homebrew
- Version: v1.5.7 (last open-source version before BUSL license)
- Note: Homebrew won't update beyond this due to license change
## 2026-02-20 14:59 - US-001
- Initialized bun workspace
- packages/aws-mock created with Hono, Effect dependencies
- packages/terraform-provider-aws-mock created (empty, for Go provider)
- bun install succeeded
---

## 2026-02-20 15:20 - US-003
- Dumped AWS provider schema (hashicorp/aws v5.100.0) to packages/aws-mock/schema/aws-provider-schema.json
- Created temp terraform config in /tmp/tf-schema-dump to download provider and dump schema
- Added schema validation tests in packages/aws-mock/tests/schema.test.ts
- Added .gitignore (node_modules, .terraform, tfstate files)
- Files changed: packages/aws-mock/schema/aws-provider-schema.json, packages/aws-mock/tests/schema.test.ts, .gitignore
- **Learnings for future iterations:**
  - Schema is 13MB, contains 1526 resource types from AWS provider v5.100.0
  - Provider schema key format is `registry.terraform.io/hashicorp/aws`
  - Schema structure: `provider_schemas[key].resource_schemas[resource_type]`
  - `terraform providers schema -json` requires `terraform init` to have been run first
  - oxfmt is not installed globally; use `npx oxfmt` as fallback
---

## 2026-02-20 - US-004
- Created schema parser utility at `packages/aws-mock/src/utils/schema-parser.ts`
- Created tests at `packages/aws-mock/tests/schema-parser.test.ts` (8 tests)
- Files changed: packages/aws-mock/src/utils/schema-parser.ts, packages/aws-mock/tests/schema-parser.test.ts
- **Learnings for future iterations:**
  - Terraform schema attributes have 3 categories: required, optional (may also be computed), computed-only
  - `bucket` in aws_s3_bucket is optional+computed (auto-generated if omitted)
  - Most aws_s3_bucket nested blocks are deprecated in favor of standalone resources (e.g., aws_s3_bucket_versioning)
  - Schema block_types have nesting_mode: "single", "list", or "set"
  - normalizeType helper needed to handle Terraform type tuples like `["map", "string"]` → `"map(string)"`
---

## 2026-02-20 - US-005
- Defined ResourceHandler, ResourceContext, ResourceResult types at `packages/aws-mock/src/resources/types.ts`
- Created tests at `packages/aws-mock/tests/resource-handler.test.ts` (6 tests)
- Files changed: packages/aws-mock/src/resources/types.ts, packages/aws-mock/tests/resource-handler.test.ts
- **Learnings for future iterations:**
  - ResourceContext: `{ resourceType: string, attributes: Record<string, unknown>, id?: string }`
  - ResourceResult: `{ id: string, attributes: Record<string, unknown> }`
  - ResourceHandler: `{ create, read, update, delete }` — read returns null for not-found, delete returns void
  - Types compile cleanly with `npx -p typescript tsc --noEmit --strict`
---

## 2026-02-20 - US-006
- Created StateStore class at `packages/aws-mock/src/state/store.ts`
- Created tests at `packages/aws-mock/tests/state-store.test.ts` (12 tests)
- Files changed: packages/aws-mock/src/state/store.ts, packages/aws-mock/tests/state-store.test.ts
- **Learnings for future iterations:**
  - State stored as JSON file with `{ version: 1, resources: { [type]: { [id]: { id, attributes } } } }`
  - StateStore constructor takes file path, creates file/dirs on first write
  - load() returns empty state if file doesn't exist (no error)
  - update/delete throw if resource not found
  - Tests use temp dirs (mkdtemp) cleaned up in afterEach
---

## 2026-02-20 - US-007
- Created computed value generators at `packages/aws-mock/src/utils/computed.ts`
- Created tests at `packages/aws-mock/tests/computed.test.ts` (7 tests)
- Files changed: packages/aws-mock/src/utils/computed.ts, packages/aws-mock/tests/computed.test.ts
- **Learnings for future iterations:**
  - S3 ARN format: `arn:aws:s3:::bucket-name` (three colons before bucket, no region/account)
  - S3 ID is just the bucket name
  - S3 domain differs by region: us-east-1 uses `bucket.s3.amazonaws.com`, others use `bucket.s3.region.amazonaws.com`
  - Mock account ID is a fixed 12-digit string "123456789012" — consistent across calls for deterministic tests
  - These generators will be used by resource handlers (US-008+) to populate computed attributes
---

## 2026-02-20 - US-008
- Created aws_s3_bucket resource handler at `packages/aws-mock/src/resources/s3-bucket.ts`
- Created tests at `packages/aws-mock/tests/s3-bucket.test.ts` (10 tests)
- Files changed: packages/aws-mock/src/resources/s3-bucket.ts, packages/aws-mock/tests/s3-bucket.test.ts
- **Learnings for future iterations:**
  - Resource handlers use factory pattern: `createS3BucketHandler(store)` returns a `ResourceHandler`
  - Handler builds computed attributes (arn, id, domain names, region, hosted_zone_id) on create/update
  - `bucket_domain_name` always uses us-east-1 format (no region in URL), `bucket_regional_domain_name` always includes region
  - Default values: force_destroy=false, tags={}, tags_all mirrors tags
  - Read delegates directly to state store, delete delegates directly to state store
  - Tests use same temp dir pattern as state-store tests (mkdtemp + cleanup in afterEach)
---

## 2026-02-20 - US-009
- Created aws_s3_bucket_policy resource handler at `packages/aws-mock/src/resources/s3-bucket-policy.ts`
- Created tests at `packages/aws-mock/tests/s3-bucket-policy.test.ts` (8 tests)
- Files changed: packages/aws-mock/src/resources/s3-bucket-policy.ts, packages/aws-mock/tests/s3-bucket-policy.test.ts
- **Learnings for future iterations:**
  - aws_s3_bucket_policy is one of the simplest resource types: bucket (required), policy (required), id (computed = bucket name)
  - No nested blocks, no optional attributes, no extra computed values
  - Reference support: Terraform core resolves references before calling the provider, so the mock just stores the already-resolved values
  - Tests include cross-resource scenario: create bucket, then create policy referencing bucket's ARN
  - Same factory pattern as s3-bucket: `createS3BucketPolicyHandler(store)` returns ResourceHandler
---

