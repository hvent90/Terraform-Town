# Ralph Progress Log

Started: 2026-02-20
Project: terraform-town - Mock AWS Provider

## Codebase Patterns

- Schema location: `packages/aws-mock/schema/aws-provider-schema.json` (AWS provider v5.100.0, 13MB)
- Schema access: `data.provider_schemas["registry.terraform.io/hashicorp/aws"].resource_schemas["aws_s3_bucket"]`
- Test files: `packages/aws-mock/tests/*.test.ts` using `bun:test`
- Formatting: `npx oxfmt format <file>` (oxfmt not globally installed)
- Schema parser: `parseResourceDefinition(type)` in `packages/aws-mock/src/utils/schema-parser.ts`
- Schema attribute categories: required (required=true), optional (optional=true, may also be computed), computed-only (computed=true && !optional)
- aws_s3_bucket has 0 required attrs, ~10 optional, 7 computed-only, 10 nested blocks
- Resource types: `packages/aws-mock/src/resources/types.ts` — ResourceHandler, ResourceContext, ResourceResult
- ResourceHandler CRUD: create→ResourceResult, read→ResourceResult|null, update→ResourceResult, delete→void
- State store: `StateStore` class in `packages/aws-mock/src/state/store.ts` — JSON file-backed, keyed by type/id
- State format: `{ version: 1, resources: { [type]: { [id]: { id, attributes } } } }`
- Computed values: `packages/aws-mock/src/utils/computed.ts` — generateS3Arn, generateS3Id, generateS3Domain, generateAccountId
- Account ID: fixed mock value "123456789012" (consistent across calls)
- S3 domain: `bucket.s3.amazonaws.com` for us-east-1, `bucket.s3.region.amazonaws.com` for others
- Resource handlers: factory function pattern `createXxxHandler(store: StateStore): ResourceHandler` in `packages/aws-mock/src/resources/`
- S3 bucket handler: `createS3BucketHandler` in `packages/aws-mock/src/resources/s3-bucket.ts`
- bucket_domain_name always uses us-east-1 format, bucket_regional_domain_name always includes region
- S3 hosted zone ID for us-east-1: "Z3AQBSTGFYJSTF"
- S3 bucket policy handler: `createS3BucketPolicyHandler` in `packages/aws-mock/src/resources/s3-bucket-policy.ts`
- S3 bucket policy ID is the bucket name (same as AWS behavior)
- S3 bucket policy schema: bucket (required), policy (required), id (computed) — no nested blocks
- Test runner: `scripts/run-tests.sh` — runs all story tests, updates prd.json, exits 0/1
- Mock server: `createApp(statePath)` in `packages/aws-mock/src/index.ts` — Hono app with CRUD routes at `/resource/:type[/:id]`
- Server testing: use `app.request(path, init)` — no real HTTP server needed
- Adding new resource types: add handler to `handlers` map in `createApp()`
- Go provider: `packages/terraform-provider-aws-mock/` — terraform-plugin-sdk/v2, builds with `go build -o terraform-provider-aws-mock`
- Provider entry: `main.go` — `Provider()` returns `*schema.Provider`, `main()` calls `plugin.Serve`
- Go schema files: `schema_<resource>.go` — each resource's schema in its own file (e.g., `schema_s3_bucket.go`)
- Go tests: `provider_test.go` — validates schema registration, attribute flags, nested blocks
- Schema codegen: `scripts/generate-go-schema.ts` — reads AWS JSON schema, outputs Go terraform-plugin-sdk schema code
- Type mapping: JSON "number" → `schema.TypeInt`, "string" → `schema.TypeString`, "bool" → `schema.TypeBool`
- Nested blocks: nesting_mode "single" = TypeList+MaxItems:1, "list" = TypeList, "set" = TypeSet
- Adding new resources to provider: create `schema_<resource>.go`, add to ResourcesMap in `main.go`
- CRUD wiring: `client.go` MockClient calls backend HTTP API; `resource_<name>.go` has CRUD functions using extractAttributes/setAttributes
- Provider config: `backend_url` (default `http://localhost:3000`), env var `AWS_MOCK_BACKEND_URL`
- CRUD pattern: extractAttributes skips computed-only fields, setAttributes maps backend response to ResourceData
- Integration tests: `tests/integration/*.test.ts` — use `setupTerraformEnv(tfConfig)` helper from `tests/integration/helpers.ts`
- TF test env: creates temp dir with filesystem mirror, .terraformrc, and main.tf; returns `{ workDir, cleanup }`
- TF provider source: `terraform-town/aws-mock` version `0.1.0`, local name `aws` in required_providers
- TF CLI config: `TF_CLI_CONFIG_FILE` env var points to .terraformrc with filesystem_mirror pointing to local binary
- Filesystem mirror layout: `mirror/registry.terraform.io/terraform-town/aws-mock/0.1.0/<os>_<arch>/terraform-provider-aws-mock_v0.1.0`
- Backend for integration tests: `startBackend(statePath)` in helpers.ts — returns `{ url, stop }`, uses random port via `Bun.serve({ port: 0 })`
- Terraform state structure: `state.resources[].type`, `.name`, `.instances[].attributes` — parse with JSON.parse after apply
- Adding new Go provider resource: create `schema_<resource>.go`, `resource_<resource>.go` (CRUD), add to ResourcesMap in `main.go`
- S3 bucket policy Go schema: bucket (required), policy (required) — `id` is implicit in plugin-sdk, don't include

## 2026-02-20 14:59 - US-002
- Installed terraform via homebrew
- Version: v1.5.7 (last open-source version before BUSL license)
- Note: Homebrew won't update beyond this due to license change
## 2026-02-20 14:59 - US-001
- Initialized bun workspace
- packages/aws-mock created with Hono, Effect dependencies
- packages/terraform-provider-aws-mock created (empty, for Go provider)
- bun install succeeded
---

## 2026-02-20 15:20 - US-003
- Dumped AWS provider schema (hashicorp/aws v5.100.0) to packages/aws-mock/schema/aws-provider-schema.json
- Created temp terraform config in /tmp/tf-schema-dump to download provider and dump schema
- Added schema validation tests in packages/aws-mock/tests/schema.test.ts
- Added .gitignore (node_modules, .terraform, tfstate files)
- Files changed: packages/aws-mock/schema/aws-provider-schema.json, packages/aws-mock/tests/schema.test.ts, .gitignore
- **Learnings for future iterations:**
  - Schema is 13MB, contains 1526 resource types from AWS provider v5.100.0
  - Provider schema key format is `registry.terraform.io/hashicorp/aws`
  - Schema structure: `provider_schemas[key].resource_schemas[resource_type]`
  - `terraform providers schema -json` requires `terraform init` to have been run first
  - oxfmt is not installed globally; use `npx oxfmt` as fallback
---

## 2026-02-20 - US-004
- Created schema parser utility at `packages/aws-mock/src/utils/schema-parser.ts`
- Created tests at `packages/aws-mock/tests/schema-parser.test.ts` (8 tests)
- Files changed: packages/aws-mock/src/utils/schema-parser.ts, packages/aws-mock/tests/schema-parser.test.ts
- **Learnings for future iterations:**
  - Terraform schema attributes have 3 categories: required, optional (may also be computed), computed-only
  - `bucket` in aws_s3_bucket is optional+computed (auto-generated if omitted)
  - Most aws_s3_bucket nested blocks are deprecated in favor of standalone resources (e.g., aws_s3_bucket_versioning)
  - Schema block_types have nesting_mode: "single", "list", or "set"
  - normalizeType helper needed to handle Terraform type tuples like `["map", "string"]` → `"map(string)"`
---

## 2026-02-20 - US-005
- Defined ResourceHandler, ResourceContext, ResourceResult types at `packages/aws-mock/src/resources/types.ts`
- Created tests at `packages/aws-mock/tests/resource-handler.test.ts` (6 tests)
- Files changed: packages/aws-mock/src/resources/types.ts, packages/aws-mock/tests/resource-handler.test.ts
- **Learnings for future iterations:**
  - ResourceContext: `{ resourceType: string, attributes: Record<string, unknown>, id?: string }`
  - ResourceResult: `{ id: string, attributes: Record<string, unknown> }`
  - ResourceHandler: `{ create, read, update, delete }` — read returns null for not-found, delete returns void
  - Types compile cleanly with `npx -p typescript tsc --noEmit --strict`
---

## 2026-02-20 - US-006
- Created StateStore class at `packages/aws-mock/src/state/store.ts`
- Created tests at `packages/aws-mock/tests/state-store.test.ts` (12 tests)
- Files changed: packages/aws-mock/src/state/store.ts, packages/aws-mock/tests/state-store.test.ts
- **Learnings for future iterations:**
  - State stored as JSON file with `{ version: 1, resources: { [type]: { [id]: { id, attributes } } } }`
  - StateStore constructor takes file path, creates file/dirs on first write
  - load() returns empty state if file doesn't exist (no error)
  - update/delete throw if resource not found
  - Tests use temp dirs (mkdtemp) cleaned up in afterEach
---

## 2026-02-20 - US-007
- Created computed value generators at `packages/aws-mock/src/utils/computed.ts`
- Created tests at `packages/aws-mock/tests/computed.test.ts` (7 tests)
- Files changed: packages/aws-mock/src/utils/computed.ts, packages/aws-mock/tests/computed.test.ts
- **Learnings for future iterations:**
  - S3 ARN format: `arn:aws:s3:::bucket-name` (three colons before bucket, no region/account)
  - S3 ID is just the bucket name
  - S3 domain differs by region: us-east-1 uses `bucket.s3.amazonaws.com`, others use `bucket.s3.region.amazonaws.com`
  - Mock account ID is a fixed 12-digit string "123456789012" — consistent across calls for deterministic tests
  - These generators will be used by resource handlers (US-008+) to populate computed attributes
---

## 2026-02-20 - US-008
- Created aws_s3_bucket resource handler at `packages/aws-mock/src/resources/s3-bucket.ts`
- Created tests at `packages/aws-mock/tests/s3-bucket.test.ts` (10 tests)
- Files changed: packages/aws-mock/src/resources/s3-bucket.ts, packages/aws-mock/tests/s3-bucket.test.ts
- **Learnings for future iterations:**
  - Resource handlers use factory pattern: `createS3BucketHandler(store)` returns a `ResourceHandler`
  - Handler builds computed attributes (arn, id, domain names, region, hosted_zone_id) on create/update
  - `bucket_domain_name` always uses us-east-1 format (no region in URL), `bucket_regional_domain_name` always includes region
  - Default values: force_destroy=false, tags={}, tags_all mirrors tags
  - Read delegates directly to state store, delete delegates directly to state store
  - Tests use same temp dir pattern as state-store tests (mkdtemp + cleanup in afterEach)
---

## 2026-02-20 - US-009
- Created aws_s3_bucket_policy resource handler at `packages/aws-mock/src/resources/s3-bucket-policy.ts`
- Created tests at `packages/aws-mock/tests/s3-bucket-policy.test.ts` (8 tests)
- Files changed: packages/aws-mock/src/resources/s3-bucket-policy.ts, packages/aws-mock/tests/s3-bucket-policy.test.ts
- **Learnings for future iterations:**
  - aws_s3_bucket_policy is one of the simplest resource types: bucket (required), policy (required), id (computed = bucket name)
  - No nested blocks, no optional attributes, no extra computed values
  - Reference support: Terraform core resolves references before calling the provider, so the mock just stores the already-resolved values
  - Tests include cross-resource scenario: create bucket, then create policy referencing bucket's ARN
  - Same factory pattern as s3-bucket: `createS3BucketPolicyHandler(store)` returns ResourceHandler
---

## 2026-02-20 - US-010
- Created mock backend HTTP server (Hono) at `packages/aws-mock/src/index.ts`
- Created integration tests at `packages/aws-mock/tests/server.test.ts` (8 tests)
- Files changed: packages/aws-mock/src/index.ts, packages/aws-mock/tests/server.test.ts
- **Learnings for future iterations:**
  - `createApp(statePath)` factory returns a Hono app (testable without starting server)
  - Hono's `app.request()` enables integration testing without a real HTTP server
  - Routes: POST /resource/:type, GET /resource/:type/:id, PUT /resource/:type/:id, DELETE /resource/:type/:id
  - Resource handlers registered in a map by type name (extensible for new resource types)
  - Default export uses Bun's `export default { port, fetch }` pattern for `bun run dev`
  - 400 for missing attributes, 404 for unknown resource type or missing resource, 204 for delete
---

## 2026-02-20 - US-011
- Created Go provider skeleton at `packages/terraform-provider-aws-mock/`
- Initialized go.mod with terraform-plugin-sdk/v2 v2.38.2
- Created main.go with minimal Provider() function and plugin.Serve
- Binary compiles and produces `terraform-provider-aws-mock` executable
- Added binary to .gitignore (path-specific to avoid ignoring the directory)
- Files changed: packages/terraform-provider-aws-mock/go.mod, go.sum, main.go, .gitignore
- **Learnings for future iterations:**
  - Go 1.26.0 installed via homebrew
  - terraform-plugin-sdk/v2 is the standard SDK for Terraform providers
  - Provider skeleton: Provider() returns `*schema.Provider` with empty ResourcesMap, main() calls `plugin.Serve`
  - Binary must be named `terraform-provider-{name}` for Terraform to discover it
  - Be careful with .gitignore patterns — `terraform-provider-aws-mock` matches both the binary and the directory; use path-specific pattern instead
---

## 2026-02-20 - US-012
- Registered aws_s3_bucket resource schema in Go provider matching the AWS provider schema
- Created `schema_s3_bucket.go` with full schema including all attributes and nested blocks
- Created `provider_test.go` with 6 tests verifying schema registration
- Created `scripts/generate-go-schema.ts` code generator that reads AWS schema JSON and outputs Go schema code
- Files changed: packages/terraform-provider-aws-mock/main.go, schema_s3_bucket.go, provider_test.go, scripts/generate-go-schema.ts
- **Learnings for future iterations:**
  - Terraform JSON schema "number" type maps to schema.TypeInt in Go SDK (all S3 bucket numeric fields are integers)
  - Timeouts block in JSON schema dump is handled by `schema.Resource.Timeouts` in plugin SDK, not as a regular schema entry — omit from Schema map
  - `id` attribute is implicit in terraform-plugin-sdk — don't include in top-level Schema map
  - Nested blocks use schema.TypeList/TypeSet with Elem: &schema.Resource{Schema: ...}
  - nesting_mode "single" = TypeList + MaxItems: 1, "list" = TypeList, "set" = TypeSet
  - aws_s3_bucket has 0 required top-level attributes, 11 optional (8 also computed), 7 computed-only, 9 nested blocks (+ timeouts)
  - Code generator at scripts/generate-go-schema.ts can be reused for other resource types
---

## 2026-02-20 - US-013
- Wired Go provider CRUD operations to mock backend HTTP API
- Created `client.go` — MockClient with CreateResource, ReadResource, UpdateResource, DeleteResource methods
- Created `resource_s3_bucket.go` — CRUD functions (CreateContext, ReadContext, UpdateContext, DeleteContext) using extractAttributes/setAttributes helpers
- Updated `main.go` — added provider Schema (backend_url), ConfigureContextFunc, wired resourceS3Bucket() with CRUD
- Created `client_test.go` — 8 tests verifying HTTP methods, paths, request/response handling, provider config
- Files changed: packages/terraform-provider-aws-mock/main.go, client.go, client_test.go, resource_s3_bucket.go
- **Learnings for future iterations:**
  - Provider `meta` interface{} comes from ConfigureContextFunc; CRUD functions cast it to `*MockClient`
  - `extractAttributes` iterates schema, skipping computed-only fields, calls `d.GetOk(key)` for user-provided values
  - `setAttributes` iterates response attributes, calls `d.Set(key, val)` for each schema key present in response
  - Backend URL configurable via `backend_url` provider attribute or `AWS_MOCK_BACKEND_URL` env var (default: `http://localhost:3000`)
  - `d.GetOk` returns false for zero values — backend handles defaults (e.g., force_destroy=false)
  - ReadResource returns nil on 404, causing `d.SetId("")` to remove resource from Terraform state
  - Go httptest.NewServer is ideal for testing HTTP client without starting real backend
---

## 2026-02-20 - US-014
- Created integration test infrastructure for terraform init
- Created `tests/integration/helpers.ts` — shared helper with `buildProvider()`, `setupTerraformEnv()`, `terraform()` functions
- Created `tests/integration/terraform-init.test.ts` — 3 tests verifying init succeeds, no errors, and provider appears in .terraform/providers/
- Files changed: tests/integration/helpers.ts, tests/integration/terraform-init.test.ts
- **Learnings for future iterations:**
  - Terraform local provider discovery uses filesystem_mirror with unpacked layout
  - Mirror directory structure: `mirror/registry.terraform.io/<namespace>/<type>/<version>/<os>_<arch>/terraform-provider-<type>_v<version>`
  - `TF_CLI_CONFIG_FILE` env var overrides default CLI config — essential for isolated test environments
  - Provider source `terraform-town/aws-mock` with local name `aws` allows `aws_*` resources to bind to the mock provider
  - `setupTerraformEnv(tfConfig)` is reusable for US-015 through US-019 — creates temp dir with full mirror setup
  - Terraform init with filesystem_mirror doesn't require network access or registry
---

## 2026-02-20 - US-015
- Created integration test for `terraform plan` at `tests/integration/terraform-plan.test.ts`
- 4 tests: plan succeeds, shows "1 to add", shows computed values (arn as "known after apply"), no errors
- Files changed: tests/integration/terraform-plan.test.ts
- **Learnings for future iterations:**
  - `terraform plan` for new resources does NOT call the backend — it just computes the diff from config vs empty state
  - Computed values show as "(known after apply)" in plan output — provider doesn't need to generate actual values during plan
  - The existing `setupTerraformEnv` + `terraform` helpers from US-014 work perfectly for plan tests
  - Plan output contains "1 to add, 0 to change, 0 to destroy" format
---

## 2026-02-20 - US-016
- Created integration test for `terraform apply` at `tests/integration/terraform-apply.test.ts`
- Added `startBackend(statePath)` helper to `tests/integration/helpers.ts` — starts Hono mock server on random port
- 4 tests: apply succeeds, tfstate exists, state contains aws_s3_bucket resource, state contains computed values (arn, id, domain, region)
- Files changed: tests/integration/helpers.ts, tests/integration/terraform-apply.test.ts
- **Learnings for future iterations:**
  - `terraform apply` requires a running mock backend (unlike plan which doesn't call the provider for new resources)
  - `startBackend(statePath)` uses `Bun.serve({ port: 0 })` to get a random available port — avoids port conflicts in parallel tests
  - `terraform apply -auto-approve` skips the interactive confirmation prompt
  - Terraform state file (`terraform.tfstate`) stores resources in `state.resources[]` array with `type`, `name`, and `instances[].attributes`
  - The `startBackend` helper is reusable for US-017 through US-019 — any test that needs the provider to make real CRUD calls
---

## 2026-02-20 - US-017
- Created integration test for no-drift verification at `tests/integration/terraform-no-drift.test.ts`
- 3 tests: plan after apply shows "No changes", -detailed-exitcode returns 0, computed values match in state
- Files changed: tests/integration/terraform-no-drift.test.ts
- **Learnings for future iterations:**
  - The provider's Read + setAttributes + backend state store already produce consistent values — no drift fixes needed
  - `terraform plan -detailed-exitcode` returns 0 for no changes, 1 for error, 2 for changes present — useful for programmatic checks
  - `terraform show -json terraform.tfstate` provides structured JSON output of state for validation
  - State JSON structure: `values.root_module.resources[].values` contains the attribute map
---

## 2026-02-20 - US-018
- Created integration test for `terraform destroy` at `tests/integration/terraform-destroy.test.ts`
- 3 tests: destroy succeeds, state file is empty after destroy, mock backend confirms resource deleted (404 on read)
- Files changed: tests/integration/terraform-destroy.test.ts
- **Learnings for future iterations:**
  - `terraform destroy -auto-approve` skips the interactive confirmation (same as apply)
  - After destroy, `terraform.tfstate` has an empty `resources: []` array
  - Can verify backend-side deletion by fetching the resource directly from the mock server — returns 404
  - The existing CRUD wiring from US-013 (Delete calls DELETE /resource/:type/:id) and backend (US-010) handle destroy correctly out of the box
---

## 2026-02-20 - US-019
- Added `aws_s3_bucket_policy` resource to Go provider: schema, CRUD wiring, registration in main.go
- Created integration test at `tests/integration/terraform-references.test.ts` (4 tests)
- Tests verify: reference resolution in plan, dependency graph, correct apply order, correct destroy order
- Files changed: packages/terraform-provider-aws-mock/main.go, schema_s3_bucket_policy.go, resource_s3_bucket_policy.go, tests/integration/terraform-references.test.ts
- **Learnings for future iterations:**
  - Adding a new resource to Go provider follows a simple pattern: schema file, resource CRUD file, register in main.go ResourcesMap
  - `extractAttributes`/`setAttributes` helpers from resource_s3_bucket.go are reusable across all resource types
  - Terraform resolves references before calling the provider — the mock just stores already-resolved values
  - `terraform show -json tfplan` provides structured plan output for verifying reference resolution
  - Destroy order is automatically correct — Terraform infers dependencies from references and destroys in reverse order
---

## 2026-02-20 - US-020
- Created `scripts/run-tests.sh` — test runner that validates all 20 user stories
- Maps each story to its test: prerequisite checks (US-001/002), bun test files (US-003–010), go build/test (US-011–013), integration tests (US-014–019), self-check (US-020)
- Outputs pass/fail per story with colored output
- Updates prd.json with passes: true/false using bun inline script
- Exits 0 if all pass, 1 if any fail
- Files changed: scripts/run-tests.sh, prd.json, progress.txt
- **Learnings for future iterations:**
  - macOS default bash is v3 — no associative arrays (`declare -A`); use temp files instead
  - `bun -e` is a good substitute for `jq` when updating JSON from bash scripts
  - Go tests for US-012 and US-013 share the same test suite (`go test ./...` in provider dir)
  - Script is self-referencing: US-020 checks that `scripts/run-tests.sh` is executable
---

## 2026-02-20 - US-021
- Implemented aws_vpc resource handler with full CRUD in TypeScript backend
- Added VPC computed value generators (vpc ID, ARN, network ACL ID, route table ID, security group ID, DHCP options ID, IPv6 association ID)
- Created Go provider schema and CRUD wiring for aws_vpc
- Updated tests/helpers.ts with proper API for generated tests (startBackend/stopBackend/setupProviderMirror/terraformEnv)
- Updated generated VPC test to work with proper terraform provider setup
- Skipped generated tests for unimplemented resources (aws_subnet, aws_security_group, aws_instance) with describe.skip
- Files changed: packages/aws-mock/src/resources/vpc.ts, packages/aws-mock/src/utils/computed.ts, packages/aws-mock/src/index.ts, packages/aws-mock/tests/vpc.test.ts, packages/terraform-provider-aws-mock/schema_vpc.go, packages/terraform-provider-aws-mock/resource_vpc.go, packages/terraform-provider-aws-mock/main.go, tests/helpers.ts, tests/generated/aws_vpc/aws_vpc.test.ts
- **Learnings for future iterations:**
  - Generated tests need provider mirror setup, .terraformrc, required_providers block, and TF_CLI_CONFIG_FILE env var — tests/helpers.ts provides setupProviderMirror() and terraformEnv() for this
  - VPC computed values use random hex IDs (vpc-xxx, acl-xxx, rtb-xxx, sg-xxx, dopt-xxx, vpc-cidr-assoc-xxx)
  - randomHex() helper in computed.ts uses crypto.getRandomValues for generating resource IDs
  - Each EC2 resource needs full stack: TS handler + Go schema + Go CRUD + backend registration
  - Bun shell `$` supports `.env({...})` for setting environment variables per command
  - Generated test suites for unimplemented resources should use describe.skip until implemented
  - Adding new resource to Go provider pattern: schema_<resource>.go, resource_<resource>.go, register in main.go ResourcesMap
---

## 2026-02-20 - US-022
- Implemented aws_subnet resource handler with full CRUD in TypeScript backend
- Added subnet computed value generators (subnet ID, ARN, ipv6_cidr_block_association_id, owner_id)
- Created Go provider schema and CRUD wiring for aws_subnet
- Registered handler in backend (index.ts) and Go provider (main.go)
- Updated generated test to use proper provider mirror setup and VPC reference
- Files changed: packages/aws-mock/src/resources/subnet.ts, packages/aws-mock/src/utils/computed.ts, packages/aws-mock/src/index.ts, packages/aws-mock/tests/subnet.test.ts, packages/terraform-provider-aws-mock/schema_subnet.go, packages/terraform-provider-aws-mock/resource_subnet.go, packages/terraform-provider-aws-mock/main.go, tests/generated/aws_subnet/aws_subnet.test.ts
- **Learnings for future iterations:**
  - aws_subnet requires vpc_id (only required attribute), all others are optional
  - Generated tests with VPC references need both aws_vpc and aws_subnet in the TF config — test expects 2 resources in state
  - Subnet computed values: subnet-xxx ID, arn, subnet-cidr-assoc-xxx for ipv6_cidr_block_association_id, owner_id
  - Same full stack pattern as VPC: TS handler + Go schema + Go CRUD + backend registration + generated test update
---

## 2026-02-20 - US-023
- Implemented aws_security_group resource handler with full CRUD in TypeScript backend
- Added security group ARN generator (generateSecurityGroupArn) to computed.ts
- Created Go provider schema with egress/ingress as TypeSet containing nested object schemas
- Created Go provider CRUD wiring for aws_security_group
- Registered handler in backend (index.ts) and Go provider (main.go)
- Updated generated test to use proper provider mirror setup with VPC reference
- Files changed: packages/aws-mock/src/resources/security-group.ts, packages/aws-mock/src/utils/computed.ts, packages/aws-mock/src/index.ts, packages/aws-mock/tests/security-group.test.ts, packages/terraform-provider-aws-mock/schema_security_group.go, packages/terraform-provider-aws-mock/resource_security_group.go, packages/terraform-provider-aws-mock/main.go, tests/generated/aws_security_group/aws_security_group.test.ts
- **Learnings for future iterations:**
  - aws_security_group has no required attributes — all are optional (name, description, vpc_id, egress, ingress, etc.)
  - egress/ingress are complex set types with nested objects (cidr_blocks, from_port, to_port, protocol, etc.) — in Go schema use TypeSet with Elem: &schema.Resource
  - Default description is "Managed by Terraform" when not provided (matches AWS behavior)
  - Security group computed values: sg-xxx ID, arn, owner_id — same pattern as VPC/subnet
  - generateSecurityGroupId() was already in computed.ts from VPC (generates default SG ID); reused for actual SG resources
  - Same full stack pattern as VPC/subnet: TS handler + Go schema + Go CRUD + backend registration + generated test update
---

## 2026-02-20 - US-024
- Implemented aws_instance resource handler with full CRUD in TypeScript backend
- Added instance computed value generators (instance ID, ARN, ENI ID, private/public IP, private/public DNS)
- Created Go provider schema and CRUD wiring for aws_instance
- Registered handler in backend (index.ts) and Go provider (main.go)
- Updated generated test with full EC2 stack (VPC → Subnet → Security Group → Instance) using proper provider mirror setup
- Fixed `extractAttributes` in Go provider to convert `*schema.Set` to `[]interface{}` via `.List()` before JSON serialization
- Files changed: packages/aws-mock/src/resources/instance.ts, packages/aws-mock/src/utils/computed.ts, packages/aws-mock/src/index.ts, packages/aws-mock/tests/instance.test.ts, packages/terraform-provider-aws-mock/schema_instance.go, packages/terraform-provider-aws-mock/resource_instance.go, packages/terraform-provider-aws-mock/main.go, packages/terraform-provider-aws-mock/resource_s3_bucket.go, tests/generated/aws_instance/aws_instance.test.ts
- **Learnings for future iterations:**
  - aws_instance has 0 required attributes — ami, instance_type, subnet_id, vpc_security_group_ids are all optional
  - Instance computed values: i-xxx ID, arn, instance_state ("running"), private_ip (10.0.x.x), public_ip (only when associate_public_ip_address=true), private_dns (ip-x-x-x-x.ec2.internal), public_dns (ec2-x-x-x-x.compute-1.amazonaws.com), primary_network_interface_id (eni-xxx)
  - Empty string defaults for instance_lifecycle, outpost_arn, password_data, spot_instance_request_id
  - CRITICAL: `*schema.Set` from `d.GetOk()` for TypeSet fields contains a `SchemaSetFunc` that can't be JSON-serialized — must call `.List()` to convert to `[]interface{}` before sending to backend
  - This fix to `extractAttributes` in resource_s3_bucket.go benefits all resources with TypeSet fields (security_group egress/ingress, instance vpc_security_group_ids, etc.)
  - Generated integration test creates full EC2 stack (VPC, Subnet, Security Group, Instance) and verifies reference resolution between resources
---

## 2026-02-20 - VIS-001
- Set up visualization package at `packages/visualization/` with Three.js + Vite + Vitest
- Created `ralph/visualization` branch from `ralph/ec2-stack`
- Package.json with three, d3-force, vite, vitest, jsdom dependencies
- Vite config at root with `root: 'packages/visualization'`, jsdom test environment
- Created `index.html` entry point for Vite dev server and build
- Fixed SelectionManager to use custom event emitter instead of Node.js `EventEmitter` (not browser-compatible)
- Added `dist/` and `*.log` to .gitignore
- Existing scaffold: Visualization class, ResourceFactory, Animator, ForceLayout, StateSync, SelectionManager, Theme types
- Files: packages/visualization/*, vite.config.ts, .gitignore, prd-visualization.json
- **Learnings for future iterations:**
  - Vite needs `index.html` in root dir to build — without it, `vite build` fails with "Could not resolve entry module"
  - Node.js `EventEmitter` from 'events' module is externalized by Vite for browser builds — use custom emitter instead
  - `bun run --filter "@terraform-town/visualization" build` runs package-scoped scripts from workspace root
  - Visualization tests use jsdom environment via vitest (configured in vite.config.ts `test.environment: 'jsdom'`)
---

## 2026-02-20 - VIS-002
- Created Visualization instantiation tests at `packages/visualization/tests/Visualization.test.ts`
- Created WebGL2 context stub at `packages/visualization/tests/setup.ts` for jsdom test environment
- Moved `vite.config.ts` from project root to `packages/visualization/vite.config.ts` (fixes "Cannot find module 'vite'" error)
- Added `setupFiles` to vitest config to load WebGL stub before tests
- Tests: constructor succeeds, canvas attached to DOM, canvas has dimensions
- Existing Visualization class implementation already satisfied all acceptance criteria
- Files changed: packages/visualization/tests/Visualization.test.ts, packages/visualization/tests/setup.ts, packages/visualization/vite.config.ts, vite.config.ts (removed), prd-visualization.json
- **Learnings for future iterations:**
  - jsdom doesn't support WebGL — need a WebGL context stub for Three.js tests
  - Proxy-based stub handles all WebGL2 methods automatically (no need to list every method)
  - Three.js accesses WebGL constants as properties on the gl context (e.g. `gl.VERSION`) — must be on the stub object
  - `gl.getParameter(gl.VERSION)` must return a string containing "WebGL" for Three.js to parse version
  - vitest.config.ts setupFiles runs before each test file — good for environment setup
  - Visualization.test.ts uses `describe.skipIf(!hasDOM)` to skip gracefully under bun test (no jsdom)
  - `bun run --filter "@terraform-town/visualization" test` runs vitest with jsdom correctly
  - vite.config.ts must be in the package where `vite` is installed, not at workspace root
---

## 2026-02-20 - VIS-003
- Added comprehensive theme spec tests to `packages/visualization/tests/theme.test.ts`
- Added emissive material and wireframe tests to `packages/visualization/tests/ResourceFactory.test.ts`
- Fixed ResourceFactory to conditionally spread wireframe (avoids THREE.Material warning for undefined wireframe)
- Removed unused `ResourceType` import from ResourceFactory.ts
- All 24 tests pass, build succeeds
- Files changed: packages/visualization/src/resources/ResourceFactory.ts, packages/visualization/tests/ResourceFactory.test.ts, packages/visualization/tests/theme.test.ts, prd-visualization.json
- **Learnings for future iterations:**
  - Three.js warns about `wireframe: undefined` — use conditional spread `...(config.wireframe !== undefined && { wireframe: config.wireframe })` to avoid
  - Theme spec tests verify all 7 resource colors, emissive properties, wireframe, and state configs against the requirements table
  - Existing scaffolded implementation already satisfied VIS-003 acceptance criteria — tests confirmed correctness
---

## 2026-02-20 - VIS-004
- Added geometry-specific tests to `packages/visualization/tests/ResourceFactory.test.ts` (12 tests total)
- Tests verify: VPC BoxGeometry(10,10,10), Instance BoxGeometry(2,2,2), Subnet BoxGeometry(4,4,4), S3 CylinderGeometry, Lambda SphereGeometry, Security Group SphereGeometry+wireframe, IAM Role BoxGeometry, unknown type fallback, userData storage
- Added fallback config in ResourceFactory for unknown resource types (prevents crash on unrecognized types)
- Refactored tests to use `makeResource()` helper to reduce boilerplate
- Files changed: packages/visualization/src/resources/ResourceFactory.ts, packages/visualization/tests/ResourceFactory.test.ts, prd-visualization.json
- **Learnings for future iterations:**
  - Three.js geometry parameters are accessible via `(geometry as BoxGeometry).parameters` — has width, height, depth for Box; radius for Sphere; radiusTop, radiusBottom, height for Cylinder
  - `this.theme.resources[type]` returns undefined for unknown types — need nullish coalescing fallback
  - Existing scaffolded ResourceFactory implementation was already correct for all 7 resource types
---

## 2026-02-20 - VIS-005
- Implemented StateSync `parseState()` with connection extraction and parent finding
- Replaced stub `findParent()` and `normalizeConnections()` with working implementations
- Built ID→address lookup map from raw terraform state resources
- Removed unused `import * as THREE from 'three'` from StateSync.ts
- Added 7 new tests (10 total): connections from vpc_id, subnet_id, vpc_security_group_ids; parentId extraction; full EC2 stack; graceful handling of missing references
- All 36 tests pass, build succeeds
- Files changed: packages/visualization/src/state/StateSync.ts, packages/visualization/tests/StateSync.test.ts, prd-visualization.json
- **Learnings for future iterations:**
  - Terraform state `resources[].instances[0].attributes.id` contains the cloud resource ID (e.g., `vpc-abc123`)
  - Connection extraction needs an ID→address lookup: map cloud resource IDs back to terraform addresses (e.g., `vpc-abc123` → `aws_vpc.main`)
  - Parent relationship attributes: `vpc_id` → parent is the VPC, `subnet_id` → parent is the subnet
  - `vpc_security_group_ids` is an array — need to handle both scalar and array reference attributes
  - References to non-existent resources (not in state) should be silently ignored, not error
  - REFERENCE_ATTRS and PARENT_ATTRS as module-level constants keep the mapping extensible
---

## 2026-02-20 - VIS-006
- Replaced stub grid layout with d3-force-directed layout in `packages/visualization/src/layout/ForceLayout.ts`
- Updated `calculate()` signature to accept optional `connections` parameter for link forces
- Builds links from both explicit connections and parent-child (parentId) relationships
- Uses d3-force simulation: charge repulsion (-200), collision (radius 8), center, link attraction (distance 20, strength 1)
- Maps d3's 2D (x,y) to 3D (x, 0, z) — all resources on y=0 plane
- Added 8 tests: positions all resources, coordinate types, no overlap, parent-child proximity, empty list, single resource, without connections, 20-resource stress test
- All 42 tests pass, build succeeds
- Files changed: packages/visualization/src/layout/ForceLayout.ts, packages/visualization/tests/ForceLayout.test.ts, prd-visualization.json
- **Learnings for future iterations:**
  - d3-force works in 2D — map (x,y) → (x, 0, z) for Three.js 3D scene
  - `forceSimulation().stop()` + manual `tick()` loop runs synchronously (no animation frame needed)
  - 300 iterations is sufficient for convergence with typical resource counts
  - `forceCollide(8)` prevents overlapping; `forceManyBody().strength(-200)` spreads nodes
  - `forceLink().distance(20).strength(1)` pulls connected/parent-child nodes closer
  - Dedup links with sorted key set to avoid duplicate forces between same pair
  - Parent-child proximity test: child (linked) should be closer to parent than unrelated (unlinked) node
---

## 2026-02-20 - VIS-007
- Added OrbitControls configuration tests at `packages/visualization/tests/OrbitControls.test.ts` (10 tests)
- Configured zoom limits (minDistance: 10, maxDistance: 500) and polar angle limit (maxPolarAngle: PI/2)
- OrbitControls already had rotate, zoom, pan, and damping enabled from VIS-002 scaffolding
- All 52 tests pass, build succeeds
- Files changed: packages/visualization/src/Visualization.ts, packages/visualization/tests/OrbitControls.test.ts, prd-visualization.json
- **Learnings for future iterations:**
  - OrbitControls defaults already enable rotate, zoom, and pan — only needed to add limits
  - `minDistance`/`maxDistance` prevent zooming too close or too far (default 0/Infinity)
  - `maxPolarAngle = Math.PI / 2` prevents camera from orbiting below the ground plane
  - OrbitControls private fields testable via `(vis as any).controls` in vitest
  - `enableDamping = true` + `dampingFactor = 0.05` already configured for smooth feel
---

