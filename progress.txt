# Ralph Progress Log

Started: 2026-02-20
Project: terraform-town - Mock AWS Provider

## Codebase Patterns

- Schema location: `packages/aws-mock/schema/aws-provider-schema.json` (AWS provider v5.100.0, 13MB)
- Schema access: `data.provider_schemas["registry.terraform.io/hashicorp/aws"].resource_schemas["aws_s3_bucket"]`
- Test files: `packages/aws-mock/tests/*.test.ts` using `bun:test`
- Formatting: `npx oxfmt format <file>` (oxfmt not globally installed)
- Schema parser: `parseResourceDefinition(type)` in `packages/aws-mock/src/utils/schema-parser.ts`
- Schema attribute categories: required (required=true), optional (optional=true, may also be computed), computed-only (computed=true && !optional)
- aws_s3_bucket has 0 required attrs, ~10 optional, 7 computed-only, 10 nested blocks
- Resource types: `packages/aws-mock/src/resources/types.ts` — ResourceHandler, ResourceContext, ResourceResult
- ResourceHandler CRUD: create→ResourceResult, read→ResourceResult|null, update→ResourceResult, delete→void
- State store: `StateStore` class in `packages/aws-mock/src/state/store.ts` — JSON file-backed, keyed by type/id
- State format: `{ version: 1, resources: { [type]: { [id]: { id, attributes } } } }`
- Computed values: `packages/aws-mock/src/utils/computed.ts` — generateS3Arn, generateS3Id, generateS3Domain, generateAccountId
- Account ID: fixed mock value "123456789012" (consistent across calls)
- S3 domain: `bucket.s3.amazonaws.com` for us-east-1, `bucket.s3.region.amazonaws.com` for others
- Resource handlers: factory function pattern `createXxxHandler(store: StateStore): ResourceHandler` in `packages/aws-mock/src/resources/`
- S3 bucket handler: `createS3BucketHandler` in `packages/aws-mock/src/resources/s3-bucket.ts`
- bucket_domain_name always uses us-east-1 format, bucket_regional_domain_name always includes region
- S3 hosted zone ID for us-east-1: "Z3AQBSTGFYJSTF"
- S3 bucket policy handler: `createS3BucketPolicyHandler` in `packages/aws-mock/src/resources/s3-bucket-policy.ts`
- S3 bucket policy ID is the bucket name (same as AWS behavior)
- S3 bucket policy schema: bucket (required), policy (required), id (computed) — no nested blocks
- Test runner: `scripts/run-tests.sh` — runs all story tests, updates prd.json, exits 0/1
- Mock server: `createApp(statePath)` in `packages/aws-mock/src/index.ts` — Hono app with CRUD routes at `/resource/:type[/:id]`
- Server testing: use `app.request(path, init)` — no real HTTP server needed
- Adding new resource types: add handler to `handlers` map in `createApp()`
- Go provider: `packages/terraform-provider-aws-mock/` — terraform-plugin-sdk/v2, builds with `go build -o terraform-provider-aws-mock`
- Provider entry: `main.go` — `Provider()` returns `*schema.Provider`, `main()` calls `plugin.Serve`
- Go schema files: `schema_<resource>.go` — each resource's schema in its own file (e.g., `schema_s3_bucket.go`)
- Go tests: `provider_test.go` — validates schema registration, attribute flags, nested blocks
- Schema codegen: `scripts/generate-go-schema.ts` — reads AWS JSON schema, outputs Go terraform-plugin-sdk schema code
- Type mapping: JSON "number" → `schema.TypeInt`, "string" → `schema.TypeString`, "bool" → `schema.TypeBool`
- Nested blocks: nesting_mode "single" = TypeList+MaxItems:1, "list" = TypeList, "set" = TypeSet
- Adding new resources to provider: create `schema_<resource>.go`, add to ResourcesMap in `main.go`
- CRUD wiring: `client.go` MockClient calls backend HTTP API; `resource_<name>.go` has CRUD functions using extractAttributes/setAttributes
- Provider config: `backend_url` (default `http://localhost:3000`), env var `AWS_MOCK_BACKEND_URL`
- CRUD pattern: extractAttributes skips computed-only fields, setAttributes maps backend response to ResourceData
- Integration tests: `tests/integration/*.test.ts` — use `setupTerraformEnv(tfConfig)` helper from `tests/integration/helpers.ts`
- TF test env: creates temp dir with filesystem mirror, .terraformrc, and main.tf; returns `{ workDir, cleanup }`
- TF provider source: `terraform-town/aws-mock` version `0.1.0`, local name `aws` in required_providers
- TF CLI config: `TF_CLI_CONFIG_FILE` env var points to .terraformrc with filesystem_mirror pointing to local binary
- Filesystem mirror layout: `mirror/registry.terraform.io/terraform-town/aws-mock/0.1.0/<os>_<arch>/terraform-provider-aws-mock_v0.1.0`
- Backend for integration tests: `startBackend(statePath)` in helpers.ts — returns `{ url, stop }`, uses random port via `Bun.serve({ port: 0 })`
- Terraform state structure: `state.resources[].type`, `.name`, `.instances[].attributes` — parse with JSON.parse after apply
- Adding new Go provider resource: create `schema_<resource>.go`, `resource_<resource>.go` (CRUD), add to ResourcesMap in `main.go`
- S3 bucket policy Go schema: bucket (required), policy (required) — `id` is implicit in plugin-sdk, don't include

## 2026-02-20 14:59 - US-002
- Installed terraform via homebrew
- Version: v1.5.7 (last open-source version before BUSL license)
- Note: Homebrew won't update beyond this due to license change
## 2026-02-20 14:59 - US-001
- Initialized bun workspace
- packages/aws-mock created with Hono, Effect dependencies
- packages/terraform-provider-aws-mock created (empty, for Go provider)
- bun install succeeded
---

## 2026-02-20 15:20 - US-003
- Dumped AWS provider schema (hashicorp/aws v5.100.0) to packages/aws-mock/schema/aws-provider-schema.json
- Created temp terraform config in /tmp/tf-schema-dump to download provider and dump schema
- Added schema validation tests in packages/aws-mock/tests/schema.test.ts
- Added .gitignore (node_modules, .terraform, tfstate files)
- Files changed: packages/aws-mock/schema/aws-provider-schema.json, packages/aws-mock/tests/schema.test.ts, .gitignore
- **Learnings for future iterations:**
  - Schema is 13MB, contains 1526 resource types from AWS provider v5.100.0
  - Provider schema key format is `registry.terraform.io/hashicorp/aws`
  - Schema structure: `provider_schemas[key].resource_schemas[resource_type]`
  - `terraform providers schema -json` requires `terraform init` to have been run first
  - oxfmt is not installed globally; use `npx oxfmt` as fallback
---

## 2026-02-20 - US-004
- Created schema parser utility at `packages/aws-mock/src/utils/schema-parser.ts`
- Created tests at `packages/aws-mock/tests/schema-parser.test.ts` (8 tests)
- Files changed: packages/aws-mock/src/utils/schema-parser.ts, packages/aws-mock/tests/schema-parser.test.ts
- **Learnings for future iterations:**
  - Terraform schema attributes have 3 categories: required, optional (may also be computed), computed-only
  - `bucket` in aws_s3_bucket is optional+computed (auto-generated if omitted)
  - Most aws_s3_bucket nested blocks are deprecated in favor of standalone resources (e.g., aws_s3_bucket_versioning)
  - Schema block_types have nesting_mode: "single", "list", or "set"
  - normalizeType helper needed to handle Terraform type tuples like `["map", "string"]` → `"map(string)"`
---

## 2026-02-20 - US-005
- Defined ResourceHandler, ResourceContext, ResourceResult types at `packages/aws-mock/src/resources/types.ts`
- Created tests at `packages/aws-mock/tests/resource-handler.test.ts` (6 tests)
- Files changed: packages/aws-mock/src/resources/types.ts, packages/aws-mock/tests/resource-handler.test.ts
- **Learnings for future iterations:**
  - ResourceContext: `{ resourceType: string, attributes: Record<string, unknown>, id?: string }`
  - ResourceResult: `{ id: string, attributes: Record<string, unknown> }`
  - ResourceHandler: `{ create, read, update, delete }` — read returns null for not-found, delete returns void
  - Types compile cleanly with `npx -p typescript tsc --noEmit --strict`
---

## 2026-02-20 - US-006
- Created StateStore class at `packages/aws-mock/src/state/store.ts`
- Created tests at `packages/aws-mock/tests/state-store.test.ts` (12 tests)
- Files changed: packages/aws-mock/src/state/store.ts, packages/aws-mock/tests/state-store.test.ts
- **Learnings for future iterations:**
  - State stored as JSON file with `{ version: 1, resources: { [type]: { [id]: { id, attributes } } } }`
  - StateStore constructor takes file path, creates file/dirs on first write
  - load() returns empty state if file doesn't exist (no error)
  - update/delete throw if resource not found
  - Tests use temp dirs (mkdtemp) cleaned up in afterEach
---

## 2026-02-20 - US-007
- Created computed value generators at `packages/aws-mock/src/utils/computed.ts`
- Created tests at `packages/aws-mock/tests/computed.test.ts` (7 tests)
- Files changed: packages/aws-mock/src/utils/computed.ts, packages/aws-mock/tests/computed.test.ts
- **Learnings for future iterations:**
  - S3 ARN format: `arn:aws:s3:::bucket-name` (three colons before bucket, no region/account)
  - S3 ID is just the bucket name
  - S3 domain differs by region: us-east-1 uses `bucket.s3.amazonaws.com`, others use `bucket.s3.region.amazonaws.com`
  - Mock account ID is a fixed 12-digit string "123456789012" — consistent across calls for deterministic tests
  - These generators will be used by resource handlers (US-008+) to populate computed attributes
---

## 2026-02-20 - US-008
- Created aws_s3_bucket resource handler at `packages/aws-mock/src/resources/s3-bucket.ts`
- Created tests at `packages/aws-mock/tests/s3-bucket.test.ts` (10 tests)
- Files changed: packages/aws-mock/src/resources/s3-bucket.ts, packages/aws-mock/tests/s3-bucket.test.ts
- **Learnings for future iterations:**
  - Resource handlers use factory pattern: `createS3BucketHandler(store)` returns a `ResourceHandler`
  - Handler builds computed attributes (arn, id, domain names, region, hosted_zone_id) on create/update
  - `bucket_domain_name` always uses us-east-1 format (no region in URL), `bucket_regional_domain_name` always includes region
  - Default values: force_destroy=false, tags={}, tags_all mirrors tags
  - Read delegates directly to state store, delete delegates directly to state store
  - Tests use same temp dir pattern as state-store tests (mkdtemp + cleanup in afterEach)
---

## 2026-02-20 - US-009
- Created aws_s3_bucket_policy resource handler at `packages/aws-mock/src/resources/s3-bucket-policy.ts`
- Created tests at `packages/aws-mock/tests/s3-bucket-policy.test.ts` (8 tests)
- Files changed: packages/aws-mock/src/resources/s3-bucket-policy.ts, packages/aws-mock/tests/s3-bucket-policy.test.ts
- **Learnings for future iterations:**
  - aws_s3_bucket_policy is one of the simplest resource types: bucket (required), policy (required), id (computed = bucket name)
  - No nested blocks, no optional attributes, no extra computed values
  - Reference support: Terraform core resolves references before calling the provider, so the mock just stores the already-resolved values
  - Tests include cross-resource scenario: create bucket, then create policy referencing bucket's ARN
  - Same factory pattern as s3-bucket: `createS3BucketPolicyHandler(store)` returns ResourceHandler
---

## 2026-02-20 - US-010
- Created mock backend HTTP server (Hono) at `packages/aws-mock/src/index.ts`
- Created integration tests at `packages/aws-mock/tests/server.test.ts` (8 tests)
- Files changed: packages/aws-mock/src/index.ts, packages/aws-mock/tests/server.test.ts
- **Learnings for future iterations:**
  - `createApp(statePath)` factory returns a Hono app (testable without starting server)
  - Hono's `app.request()` enables integration testing without a real HTTP server
  - Routes: POST /resource/:type, GET /resource/:type/:id, PUT /resource/:type/:id, DELETE /resource/:type/:id
  - Resource handlers registered in a map by type name (extensible for new resource types)
  - Default export uses Bun's `export default { port, fetch }` pattern for `bun run dev`
  - 400 for missing attributes, 404 for unknown resource type or missing resource, 204 for delete
---

## 2026-02-20 - US-011
- Created Go provider skeleton at `packages/terraform-provider-aws-mock/`
- Initialized go.mod with terraform-plugin-sdk/v2 v2.38.2
- Created main.go with minimal Provider() function and plugin.Serve
- Binary compiles and produces `terraform-provider-aws-mock` executable
- Added binary to .gitignore (path-specific to avoid ignoring the directory)
- Files changed: packages/terraform-provider-aws-mock/go.mod, go.sum, main.go, .gitignore
- **Learnings for future iterations:**
  - Go 1.26.0 installed via homebrew
  - terraform-plugin-sdk/v2 is the standard SDK for Terraform providers
  - Provider skeleton: Provider() returns `*schema.Provider` with empty ResourcesMap, main() calls `plugin.Serve`
  - Binary must be named `terraform-provider-{name}` for Terraform to discover it
  - Be careful with .gitignore patterns — `terraform-provider-aws-mock` matches both the binary and the directory; use path-specific pattern instead
---

## 2026-02-20 - US-012
- Registered aws_s3_bucket resource schema in Go provider matching the AWS provider schema
- Created `schema_s3_bucket.go` with full schema including all attributes and nested blocks
- Created `provider_test.go` with 6 tests verifying schema registration
- Created `scripts/generate-go-schema.ts` code generator that reads AWS schema JSON and outputs Go schema code
- Files changed: packages/terraform-provider-aws-mock/main.go, schema_s3_bucket.go, provider_test.go, scripts/generate-go-schema.ts
- **Learnings for future iterations:**
  - Terraform JSON schema "number" type maps to schema.TypeInt in Go SDK (all S3 bucket numeric fields are integers)
  - Timeouts block in JSON schema dump is handled by `schema.Resource.Timeouts` in plugin SDK, not as a regular schema entry — omit from Schema map
  - `id` attribute is implicit in terraform-plugin-sdk — don't include in top-level Schema map
  - Nested blocks use schema.TypeList/TypeSet with Elem: &schema.Resource{Schema: ...}
  - nesting_mode "single" = TypeList + MaxItems: 1, "list" = TypeList, "set" = TypeSet
  - aws_s3_bucket has 0 required top-level attributes, 11 optional (8 also computed), 7 computed-only, 9 nested blocks (+ timeouts)
  - Code generator at scripts/generate-go-schema.ts can be reused for other resource types
---

## 2026-02-20 - US-013
- Wired Go provider CRUD operations to mock backend HTTP API
- Created `client.go` — MockClient with CreateResource, ReadResource, UpdateResource, DeleteResource methods
- Created `resource_s3_bucket.go` — CRUD functions (CreateContext, ReadContext, UpdateContext, DeleteContext) using extractAttributes/setAttributes helpers
- Updated `main.go` — added provider Schema (backend_url), ConfigureContextFunc, wired resourceS3Bucket() with CRUD
- Created `client_test.go` — 8 tests verifying HTTP methods, paths, request/response handling, provider config
- Files changed: packages/terraform-provider-aws-mock/main.go, client.go, client_test.go, resource_s3_bucket.go
- **Learnings for future iterations:**
  - Provider `meta` interface{} comes from ConfigureContextFunc; CRUD functions cast it to `*MockClient`
  - `extractAttributes` iterates schema, skipping computed-only fields, calls `d.GetOk(key)` for user-provided values
  - `setAttributes` iterates response attributes, calls `d.Set(key, val)` for each schema key present in response
  - Backend URL configurable via `backend_url` provider attribute or `AWS_MOCK_BACKEND_URL` env var (default: `http://localhost:3000`)
  - `d.GetOk` returns false for zero values — backend handles defaults (e.g., force_destroy=false)
  - ReadResource returns nil on 404, causing `d.SetId("")` to remove resource from Terraform state
  - Go httptest.NewServer is ideal for testing HTTP client without starting real backend
---

## 2026-02-20 - US-014
- Created integration test infrastructure for terraform init
- Created `tests/integration/helpers.ts` — shared helper with `buildProvider()`, `setupTerraformEnv()`, `terraform()` functions
- Created `tests/integration/terraform-init.test.ts` — 3 tests verifying init succeeds, no errors, and provider appears in .terraform/providers/
- Files changed: tests/integration/helpers.ts, tests/integration/terraform-init.test.ts
- **Learnings for future iterations:**
  - Terraform local provider discovery uses filesystem_mirror with unpacked layout
  - Mirror directory structure: `mirror/registry.terraform.io/<namespace>/<type>/<version>/<os>_<arch>/terraform-provider-<type>_v<version>`
  - `TF_CLI_CONFIG_FILE` env var overrides default CLI config — essential for isolated test environments
  - Provider source `terraform-town/aws-mock` with local name `aws` allows `aws_*` resources to bind to the mock provider
  - `setupTerraformEnv(tfConfig)` is reusable for US-015 through US-019 — creates temp dir with full mirror setup
  - Terraform init with filesystem_mirror doesn't require network access or registry
---

## 2026-02-20 - US-015
- Created integration test for `terraform plan` at `tests/integration/terraform-plan.test.ts`
- 4 tests: plan succeeds, shows "1 to add", shows computed values (arn as "known after apply"), no errors
- Files changed: tests/integration/terraform-plan.test.ts
- **Learnings for future iterations:**
  - `terraform plan` for new resources does NOT call the backend — it just computes the diff from config vs empty state
  - Computed values show as "(known after apply)" in plan output — provider doesn't need to generate actual values during plan
  - The existing `setupTerraformEnv` + `terraform` helpers from US-014 work perfectly for plan tests
  - Plan output contains "1 to add, 0 to change, 0 to destroy" format
---

## 2026-02-20 - US-016
- Created integration test for `terraform apply` at `tests/integration/terraform-apply.test.ts`
- Added `startBackend(statePath)` helper to `tests/integration/helpers.ts` — starts Hono mock server on random port
- 4 tests: apply succeeds, tfstate exists, state contains aws_s3_bucket resource, state contains computed values (arn, id, domain, region)
- Files changed: tests/integration/helpers.ts, tests/integration/terraform-apply.test.ts
- **Learnings for future iterations:**
  - `terraform apply` requires a running mock backend (unlike plan which doesn't call the provider for new resources)
  - `startBackend(statePath)` uses `Bun.serve({ port: 0 })` to get a random available port — avoids port conflicts in parallel tests
  - `terraform apply -auto-approve` skips the interactive confirmation prompt
  - Terraform state file (`terraform.tfstate`) stores resources in `state.resources[]` array with `type`, `name`, and `instances[].attributes`
  - The `startBackend` helper is reusable for US-017 through US-019 — any test that needs the provider to make real CRUD calls
---

## 2026-02-20 - US-017
- Created integration test for no-drift verification at `tests/integration/terraform-no-drift.test.ts`
- 3 tests: plan after apply shows "No changes", -detailed-exitcode returns 0, computed values match in state
- Files changed: tests/integration/terraform-no-drift.test.ts
- **Learnings for future iterations:**
  - The provider's Read + setAttributes + backend state store already produce consistent values — no drift fixes needed
  - `terraform plan -detailed-exitcode` returns 0 for no changes, 1 for error, 2 for changes present — useful for programmatic checks
  - `terraform show -json terraform.tfstate` provides structured JSON output of state for validation
  - State JSON structure: `values.root_module.resources[].values` contains the attribute map
---

## 2026-02-20 - US-018
- Created integration test for `terraform destroy` at `tests/integration/terraform-destroy.test.ts`
- 3 tests: destroy succeeds, state file is empty after destroy, mock backend confirms resource deleted (404 on read)
- Files changed: tests/integration/terraform-destroy.test.ts
- **Learnings for future iterations:**
  - `terraform destroy -auto-approve` skips the interactive confirmation (same as apply)
  - After destroy, `terraform.tfstate` has an empty `resources: []` array
  - Can verify backend-side deletion by fetching the resource directly from the mock server — returns 404
  - The existing CRUD wiring from US-013 (Delete calls DELETE /resource/:type/:id) and backend (US-010) handle destroy correctly out of the box
---

## 2026-02-20 - US-019
- Added `aws_s3_bucket_policy` resource to Go provider: schema, CRUD wiring, registration in main.go
- Created integration test at `tests/integration/terraform-references.test.ts` (4 tests)
- Tests verify: reference resolution in plan, dependency graph, correct apply order, correct destroy order
- Files changed: packages/terraform-provider-aws-mock/main.go, schema_s3_bucket_policy.go, resource_s3_bucket_policy.go, tests/integration/terraform-references.test.ts
- **Learnings for future iterations:**
  - Adding a new resource to Go provider follows a simple pattern: schema file, resource CRUD file, register in main.go ResourcesMap
  - `extractAttributes`/`setAttributes` helpers from resource_s3_bucket.go are reusable across all resource types
  - Terraform resolves references before calling the provider — the mock just stores already-resolved values
  - `terraform show -json tfplan` provides structured plan output for verifying reference resolution
  - Destroy order is automatically correct — Terraform infers dependencies from references and destroys in reverse order
---

## 2026-02-20 - US-020
- Created `scripts/run-tests.sh` — test runner that validates all 20 user stories
- Maps each story to its test: prerequisite checks (US-001/002), bun test files (US-003–010), go build/test (US-011–013), integration tests (US-014–019), self-check (US-020)
- Outputs pass/fail per story with colored output
- Updates prd.json with passes: true/false using bun inline script
- Exits 0 if all pass, 1 if any fail
- Files changed: scripts/run-tests.sh, prd.json, progress.txt
- **Learnings for future iterations:**
  - macOS default bash is v3 — no associative arrays (`declare -A`); use temp files instead
  - `bun -e` is a good substitute for `jq` when updating JSON from bash scripts
  - Go tests for US-012 and US-013 share the same test suite (`go test ./...` in provider dir)
  - Script is self-referencing: US-020 checks that `scripts/run-tests.sh` is executable
---

